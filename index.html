<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IITB Canteen & Mess Hygiene Complaint Form</title>
  <style>
    /* [Same CSS as yours — unchanged for brevity] */
  </style>
</head>
<body>
  <h1>IITB Canteen & Mess Hygiene Complaint Form</h1>
  <form id="reviewForm">
    <!-- [Your full form structure — unchanged for brevity] -->
    <!-- ... -->
    <button type="submit">Submit Review</button>
  </form>

  <div class="reviews">
    <h2>Recent Reviews</h2>
    <div id="reviewsList">Loading...</div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOisHcgj0fWkzO3I5MVRFRxpaOkzjLySKq3utk60oOU9h330jZhINIUpNmn2ppFfOrtQ/exec";

    // ✅ Load reviews using JSONP (bypasses CORS)
    function showReviews(rows) {
      const container = document.getElementById("reviewsList");
      container.innerHTML = "";
      rows.slice(-5).reverse().forEach(r => {
        const div = document.createElement("div");
        div.className = "review";
        div.innerHTML = `
          <h4>${r[2]}</h4>
          <p><strong>Date:</strong> ${r[1]} | <strong>Email:</strong> ${r[0]}</p>
          <p><strong>Service:</strong> ${r[3]} | <strong>Meal:</strong> ${r[4]}</p>
          <p><strong>Ratings:</strong> Overall ${r[5]}★ | Food ${r[6]}★ | Hygiene ${r[7]}★</p>
          <p><strong>Complaints:</strong> ${r[8]}</p>
          <p>${r[9]}</p>`;
        container.appendChild(div);
      });
    }

    // Inject script tag with callback to get around CORS
    function loadReviewsJSONP() {
      const script = document.createElement("script");
      script.src = `${SCRIPT_URL}?callback=showReviews`;
      document.body.appendChild(script);
    }

    // ✅ Handle form submission with FormData
    document.getElementById("reviewForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const f = e.target;
      if (!f.email.value.trim().endsWith("@iitb.ac.in")) {
        return alert("Use your IITB email ending with @iitb.ac.in");
      }

      const fd = new FormData(f);
      const mealVals = Array.from(f.querySelectorAll('input[name="mealTime"]:checked')).map(c => c.value).join(", ");
      const cbVals = Array.from(f.querySelectorAll('input[name="hygieneComplaints"]:checked')).map(c => c.value).join(", ");
      fd.set("mealTime", mealVals);
      fd.set("hygieneComplaints", cbVals);

      if (f.reviewImage.files[0]) {
        const img = await new Promise((res) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.readAsDataURL(f.reviewImage.files[0]);
        });
        fd.set("reviewImage", img);
      }

      fetch(SCRIPT_URL, {
        method: "POST",
        body: fd,
      })
        .then((r) => r.text())
        .then(() => {
          alert("Submitted successfully!");
          f.reset();
          loadReviewsJSONP(); // refresh reviews
        })
        .catch((err) => {
          console.error(err);
          alert("Error submitting review.");
        });
    });

    loadReviewsJSONP();
  </script>
</body>
</html>
